<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ocupados por Nivel Educativo y Sexo — Los Ríos</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    .grid-panels { display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 24px; }
    .panel { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px 12px 4px; }
    .panel h3 { font-family: Georgia, serif; font-weight: normal; font-size: 16px; margin: 6px 8px 8px; color: #1e293b; }
  </style>
  </head>
<body>
  <div class="container">
    <h1 class="main-title">Ocupados por nivel educativo y sexo — Región de Los Ríos</h1>
    <p class="subtitle">Pequeños múltiplos al estilo The Economist</p>
  <div class="econ-underline" aria-hidden="true"></div>

    <div id="status" class="status-message status-info" style="margin:16px 0; display:none;"></div>

    <div id="grid" class="grid-panels"></div>
  </div>

  <script>
  async function loadData() {
    const url = 'data/ocupados_nivel_educativo.json';
    try {
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return await r.json();
    } catch (e) {
      const st = document.getElementById('status');
      st.style.display = 'block';
      st.className = 'status-message status-error';
      st.textContent = 'No se pudo cargar ' + url + '. Genera el archivo con scripts/etl_OCU_EDU_CHL14.py';
      return null;
    }
  }

  function makeLayout(titleHtml, tickvals, ticktext) {
    return {
      title: { text: titleHtml, x: 0, font: {family:'Georgia, serif', size: 14, color:'#1e293b'} },
      font: { family: 'Georgia, serif', color: '#1e293b' },
      plot_bgcolor: 'white', paper_bgcolor: 'white',
      margin: { l: 40, r: 10, t: 40, b: 40 },
      xaxis: {
        tickmode: 'array', tickvals, ticktext, showgrid: false,
        linecolor: '#d1d5db', tickcolor: '#d1d5db'
      },
      yaxis: {
        showgrid: true, gridcolor: '#f3f4f6', gridwidth: 1,
        linecolor: '#d1d5db', tickcolor: '#d1d5db', tickformat: ','
      },
      height: 260
    };
  }

  function renderPanel(containerId, tituloPanel, trimestres, serieH, serieM, ticks) {
    const traces = [
      {
        x: trimestres, y: serieH, mode: 'lines+markers', name: 'Hombres',
        line: { color: '#1f77b4', width: 2.5 }, marker: { size: 5 }
      },
      {
        x: trimestres, y: serieM, mode: 'lines+markers', name: 'Mujeres',
        line: { color: '#e11d48', width: 2.5 }, marker: { size: 5 }
      }
    ];
    const layout = makeLayout(`<b>${tituloPanel}</b>`, ticks.tickvals, ticks.ticktext);
    Plotly.newPlot(containerId, traces, layout, { displaylogo: false });
  }

  (async function(){
    const data = await loadData();
    if (!data) return;

    const grid = document.getElementById('grid');
    grid.innerHTML = '';

    const niveles = data.niveles;
    const trimestres = data.trimestres;
    const ticks = { tickvals: data.tickvals, ticktext: data.ticktext };

    niveles.forEach((nivel, i) => {
      const panel = document.createElement('div');
      panel.className = 'panel';
      const holder = document.createElement('div');
      holder.id = 'panel-' + i;
      panel.appendChild(holder);
      grid.appendChild(panel);

      const serieH = data.series_por_nivel[nivel]?.Hombres || [];
      const serieM = data.series_por_nivel[nivel]?.Mujeres || [];
      renderPanel(holder.id, nivel, trimestres, serieH, serieM, ticks);
    });
  })();
  </script>
  </body>
  </html>
